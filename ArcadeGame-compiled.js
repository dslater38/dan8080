function bitShifter(){this.hiByte=this.loByte=this.bitShift=0;this.setShift=function(a){this.bitShift=a};this.setValue=function(a){this.lowByte=this.hiByte;this.hiByte=a};this.readValue=function(){return(this.hiByte<<8|this.lowByte)<<this.bitShift>>8}}function dipSwitch(){this.switches=[];this.wireSwitch=function(a,b){this.switches[b]=a};this.on=function(a){this.switches[a].raise()};this.off=function(a){this.switches[a].lower()}}
function hInPort(){function a(a,c){b=c?b|1<<a:b&~(1<<a)}var b=0;this.read=function(){return b};this.set=function(a){this.value=a};this.getWire=function(b){return{raise:a.bind(this,b,!0),lower:a.bind(this,b,!1)}}}function hOutPort(){this.wires=[];this.setWire=function(a,b){this.wires[a]=b};this.write=function(a){for(var b in this.wires)0!=(a&1<<b)?this.wires[b].raise():this.wires[b].lower()}}function Btn(a){this.wire=a;this.down=function(){a.raise()};this.up=function(){a.lower()}}
function audioPlayer(a){function b(a){this.raised=!1;this.play=a}this.audio=a;this.wires=[];b.prototype.raise=function(){this.raised||(this.raised=!0,this.play())};b.prototype.lower=function(){this.raised&&(this.raised=!1)};this.wires[0]=new b(this.audio.playWalk1.bind(this.audio));this.wires[1]=new b(this.audio.playWalk2.bind(this.audio));this.wires[2]=new b(this.audio.playWalk3.bind(this.audio));this.wires[3]=new b(this.audio.playWalk4.bind(this.audio));this.wires[4]=new b(this.audio.playShot.bind(this.audio));
this.wires[5]=new b(this.audio.playBaseHit.bind(this.audio));this.wires[6]=new b(this.audio.playInvHit.bind(this.audio));this.wires[8]=new b(this.audio.playUfoHit.bind(this.audio));a={play:this.audio.playUfo.bind(this.audio),pause:this.audio.ufo.pause.bind(this.audio.ufo),raise:function(){this.play()},lower:function(){this.pause()}};this.wires[7]=a}
function FlipFlop(a,b){this.flipped=a;this.flopped=b;this.value=this.flipped;this.flipflop=function(){var a=this.value;this.value=this.value==this.flipped?this.flopped:this.flipped;return a}}function rst(a){return 199|a<<3}
function gameConsole(a){function b(a,b){a.IF&&a.interrupt(b.flipflop())}function d(a){a.render()}function c(a,b){this.cpu.run(a)}this.inP0=new hInPort;this.inP1=new hInPort;this.inP2=new hInPort;this.inP3=new hInPort;this.outP3=new hOutPort;this.outP5=new hOutPort;this.dip=new dipSwitch;this.player=new audioPlayer(enableAudio());this.dip.wireSwitch(this.inP0.getWire(0),4);this.inP0.getWire(1).raise();this.inP0.getWire(2).raise();this.inP0.getWire(3).raise();this.fireBtn=new Btn(this.inP0.getWire(4));
this.leftBtn=new Btn(this.inP0.getWire(5));this.rightBtn=new Btn(this.inP0.getWire(6));this.inP0.getWire(7).raise();this.coinBtn=new Btn(this.inP1.getWire(0));this.mPlayBtn=new Btn(this.inP1.getWire(1));this.sPlayBtn=new Btn(this.inP1.getWire(2));this.fireP1Btn=new Btn(this.inP1.getWire(4));this.leftP1Btn=new Btn(this.inP1.getWire(5));this.rightP1Btn=new Btn(this.inP1.getWire(6));this.inP1.getWire(7).lower();this.dip.wireSwitch(this.inP2.getWire(0),3);this.dip.wireSwitch(this.inP2.getWire(1),5);this.tiltBtn=
new Btn(this.inP2.getWire(2));this.dip.wireSwitch(this.inP2.getWire(3),6);this.fireP2Btn=new Btn(this.inP2.getWire(4));this.leftP2Btn=new Btn(this.inP2.getWire(5));this.rightP2Btn=new Btn(this.inP2.getWire(6));this.dip.wireSwitch(this.inP2.getWire(7),7);this.shifter=new bitShifter;this.outP3.setWire(0,this.player.wires[7]);this.outP3.setWire(1,this.player.wires[4]);this.outP3.setWire(2,this.player.wires[5]);this.outP3.setWire(3,this.player.wires[6]);this.outP5.setWire(0,this.player.wires[0]);this.outP5.setWire(1,
this.player.wires[1]);this.outP5.setWire(2,this.player.wires[2]);this.outP5.setWire(3,this.player.wires[3]);this.outP5.setWire(4,this.player.wires[8]);this.flipflop=new FlipFlop(rst(1),rst(2));this.addCpu=function(a){a.attachPort(0,this.inP0.read.bind(this.inP0));a.attachPort(1,this.inP1.read.bind(this.inP1));a.attachPort(2,this.inP2.read.bind(this.inP2),this.shifter.setShift.bind(this.shifter));a.attachPort(3,this.shifter.readValue.bind(this.shifter),this.outP3.write.bind(this.outP3));a.attachPort(4,
void 0,this.shifter.setValue.bind(this.shifter));a.attachPort(5,void 0,this.outP5.write.bind(this.outP5))};this.dip.on(7);this.dip.on(3);this.dip.on(5);this.dip.off(4);this.cpu=cpu8080.create(65536);this.addCpu(this.cpu);this.loadRom=function(a,b){this.cpu.load(a,b)};this.interruptTimer=0;this.startInterrupts=function(a){0==this.interruptTimer&&(this.interruptTimer=window.setInterval(b.bind(this,this.cpu,this.flipflop),a))};this.stopInterrupts=function(){0!=this.interruptTimer&&(this.interruptTimer=
window.clearInterval(this.screenTimer));this.interruptTimer=0};var e=a.getContext("2d");this.screen=new video.Screen(this.cpu,e,a.width,a.height,!1,0);this.screen.setBackground(document.getElementById("BGCOLOR").value);this.screen.setForeground(document.getElementById("FGCOLOR").value);this.screen.clear();this.screenTimer=0;this.startVideo=function(a){0==this.screenTimer&&(this.screenTimer=window.setInterval(d.bind(this,this.screen),a))};this.stopVideo=function(){0!=this.screenTimer&&(this.screenTimer=
window.clearInterval(this.screenTimer));this.screenTimer=0};this.cpuTimer=0;this.runCpu=function(a,b){0==this.cpuTimer&&(this.cpuTimer=window.setInterval(c.bind(this,b,a),a))};this.stopCpu=function(a,b){0!=this.cpuTimer&&(this.cpuTimer=window.clearInterval(this.cpuTimer));this.cpuTimer=0};this.start=function(){this.runCpu(4,1600);this.startVideo(16);this.startInterrupts(8)};this.stop=function(){this.stopInterrupts();this.stopVideo();this.stopCpu()}}
function onLoad(){function a(a){var b;switch(a){case 67:b=c.coinBtn;break;case 50:b=c.mPlayBtn;break;case 49:b=c.sPlayBtn;break;case 37:case 65:b=c.leftP1Btn;break;case 39:case 68:b=c.rightP1Btn;break;case 32:b=c.fireP1Btn}return b}var b=invadersRom,d=document.getElementById("SCREEN"),c=new gameConsole(d);c.loadRom(0,b);var b=function(b){b=a(b.keyCode);void 0!=b&&b.down()},e=function(b){b=a(b.keyCode);void 0!=b&&b.up()};window.document.addEventListener("keydown",b,!1);window.document.addEventListener("keyup",
e,!1);d.addEventListener("keydown",b,!1);d.addEventListener("keyup",e,!1);c.start()};
